
@{
    ViewBag.Title = "Quản lý sự kiện";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="content">

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Admin/Index">Trang chủ</a></li>
            <li class="breadcrumb-item active" aria-current="page">Quản lý sự kiện</li>
        </ol>
    </nav>
    <div class="box">
        <div class="box-body">
            <button id="btnaddnews" onclick="" class="btn btn-primary" data-toggle="modal" data-target="#AddSuKien" style="float:right ; margin-top: 18px; margin-right:18px; margin-bottom:6px"><i class="fas fa-plus"></i> Thêm sự kiện</button>
            <table id="maintable" class="table table-striped table-hover" style="width:100%;z-index: -1"></table>
        </div>
    </div>
    <div class="modal" data-backdrop="static" data-keyboard="false" id="ViewSuKien">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Thông tin sự kiện</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <form>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>ID sự kiện</label>
                                <input type="text" readonly class="form-control" id="ID">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Tên sự kiện</label>
                                <input type="text" readonly class="form-control" id="TenSuKien">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="DaNhan">Thời gian bắt đầu</label>
                                <textarea readonly class="form-control" id="BatDau"> </textarea>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="MoTa">Địa điểm</label>
                                <input type="text" readonly class="form-control" id="DiaDiem">
                            </div>
                        </div>
                        <div class="form-row">
                            
                            <div class="form-group col-md-12">
                                <label for="DaNhan">Ghi chú</label>
                                <textarea readonly class="form-control" id="GhiChu"> </textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-12" >
                                <label for="MoTa">Nội dung</label>
                                <div id="NoiDung">

                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>

                </div>
            </div>
        </div>
    </div>
        <div class="modal " data-backdrop="static" tabindex="999" data-keyboard="false" id="UpdateSuKien" style="overflow-y:scroll;">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Cập nhật thông tin sự kiện</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">

                        <form>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>ID sự kiện</label>
                                    <input type="text" readonly class="form-control" id="IDEdit">
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Tên sự kiện</label>
                                    <input type="text" class="form-control" id="TenSuKienEdit">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="DaNhan">Thời gian bắt đầu</label>
                                    <input type="datetime-local" class="form-control" id="BatDauEdit" />
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="MoTa">Địa điểm</label>
                                    <input type="text" class="form-control" id="DiaDiemEdit">
                                </div>
                            </div>
                            <div class="form-row">

                                <div class="form-group col-md-12">
                                    <label for="DaNhan">Ghi chú</label>
                                    <textarea class="form-control" id="GhiChuEdit"> </textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <textarea name="NoiDungEdit" id="NoiDungEdit"></textarea>
                                <script>
                                    CKEDITOR.replace('NoiDungEdit')
                                </script>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="UpdateSuKien()" class="btn btn-primary">Lưu</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>

                    </div>
                </div>
            </div>
        </div>
            <div class="modal " data-backdrop="static" tabindex="999" data-keyboard="false" id="AddSuKien" style="overflow-y:scroll;">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Nhập thông tin sự kiện</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-row">                                 
                                    <div class="form-group col-md-6">
                                        <label>Tên sự kiện</label>
                                        <input type="text" class="form-control" id="TenSuKienAdd">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="DaNhan">Thời gian bắt đầu</label>
                                        <input type="datetime-local" class="form-control" id="BatDauAdd" />
                                    </div>
                                    @*<div class="form-group col-md-6">
                                    <label for="DaNhan">Nội dung</label>
                                    <input type="text" class="form-control" id="NoiDungAdd">
                                </div>*@
                                    <div class="form-group col-md-6">
                                        <label for="MoTa">Địa điểm</label>
                                        <input type="text" class="form-control" id="DiaDiemAdd">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label for="DaNhan">Ghi chú</label>
                                        <textarea class="form-control" id="GhiChuAdd"> </textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <textarea name="NoiDungAdd" id="NoiDungAdd"></textarea>
                                    <script>
                                        CKEDITOR.replace('NoiDungAdd')
                                    </script>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">

                            <button type="button" onclick="AddSuKien()" class="btn btn-primary">Lưu</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal" style="width:100%" data-backdrop="static" data-keyboard="false" id="TraCuu">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Danh sách đoàn viên đăng ký</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">

                            <table id="TraCuuTable" class="table table-striped table-hover" style="width:100%;z-index: -1"></table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
</section>
<script src="/Content/bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="/Content/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="/Content/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="/Content/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="/Content/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="/Content/bower_components/fastclick/lib/fastclick.js"></script>
<script src="/Content/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<script>
    var DangKys;
    var SanPham;
    function ListAll() {
        $.ajax({
            type: "GET",
            url: "/SuKien/GetAll",
            dataType: "json",
            success: function (dt) {
                console.log(dt)
                document.getElementById("maintable").innerHTML = "";
                DangKys = dt;
                filldata('maintable', DangKys);
            },
            complete: function (data) {

            },
            error: function (err) {
            }
        });

    }
    $(document).ready(function () {
        ListAll();
    });
    var IDSuKien = 0;
    function filldata(table_id, data) {
        var dataSet = new Array;
        $.each(data,
            function (index, value) {
                var tempArray = new Array;
                for (var o in value) {
                    tempArray.push(value[o]);
                }
                dataSet.push(tempArray);
            });
        tabledt = $('#' + table_id + '').removeAttr('width').DataTable({
            select: true,
            "destroy": true,
            data: dataSet,

            "oLanguage": {

                "sProcessing": "Đang xử lý...",
                "sLengthMenu": "Xem _MENU_ mục",
                "sZeroRecords": "Không tìm thấy dòng nào phù hợp",
                "sInfo": "Đang xem _START_ đến _END_ trong tổng số _TOTAL_ mục",
                "sInfoEmpty": "Đang xem 0 đến 0 trong tổng số 0 mục",
                "sInfoFiltered": "(được lọc từ _MAX_ mục)",
                "sInfoPostFix": "",
                "sSearch": "Tìm:",
                "sUrl": "",
                "oPaginate": {
                    "sFirst": "Đầu",
                    "sPrevious": "Trước",
                    "sNext": "Tiếp",
                    "sLast": "Cuối"

                }
            },
            columns: [
                { title: "ID sự kiện" },
                { title: "Tên sự kiện" },
                { title: "Nội dung", visible: false },
                { title: "Địa điểm" },
                { title: "Ngày bắt đầu", },
                { title: "Ghi chú" },
                { title: "Tác vụ", "width": "12%" },
                //{ title: "Tài khoản sửa", "visible": false },
                //{ title: "Ngày sửa", "visible": false },

            ],
            "columnDefs": [
                { type: 'de_date', targets: 4 },
                {
                "targets": -1,
                "data": null,
                "defaultContent": "<a id=" + "viewct" + " data-toggle=" + "modal" + " data-target=" + "#ViewSuKien" + ">" + "<i class=" + "'fas fa-eye'" + "></i>" + "<span> &ensp;</span></a>"
                    + "<a id=" + "suact" + " data-toggle=" + "modal" + " data-target=" + "#UpdateSuKien" + " >" + " <i class= " + "'fas fa-edit'" + " ></i>" + "<span> &ensp;</span></a>"
                    + "<a id=" + "tracuu" + " data-toggle=" + "modal" + " data-target=" + "#TraCuu" + " >" + " <i class= " + "'fas fa-search'" + " ></i>" + "<span> &ensp;</span></a>"

                    + "<a id=" + "xoact" + " >" + " <i class= " + "'fas fa-trash-alt'" + " ></i> " + "</a> "+ "<span> &ensp;</span></a>"
                    + "<a id=" + "send_all" + " >" + " <i class= " + "'fas fa-envelope'" + " ></i> " + "</a> "
              
            }],
            "order": [[0, "desc"]]
        });
        $('#' + table_id + ' tbody').on('click', '#viewct', function () {
            var data = tabledt.row($(this).parents('tr')).data();
            $('#ID').val(data[0]);
            $('#NoiDung').html(data[2]);
            $('#TenSuKien').val(data[1]);
            $('#DiaDiem').val(data[3]);
            $('#BatDau').val(data[4]);
            $('#GhiChu').val(data[5]);
        });
        $('#' + table_id + ' tbody').on('click', '#suact', function () {
            
            var data = tabledt.row($(this).parents('tr')).data();
            $('#IDEdit').val(data[0]);
            $('#TenSuKienEdit').val(data[1]);
            $('#DiaDiemEdit').val(data[3]);
            var d=new Date(data[4]);
            console.log( d.toISOString().slice(0,16))
            document.getElementById('BatDauEdit').value = d.toISOString().slice(0,16);
          //  $('#BatDauEdit').val(d.toLocaleString());
            $('#GhiChuEdit').val(data[5]);
            if (data[2] == "") {
                CKEDITOR.instances.NoiDungEdit.setData("Chưa nhập nội dung");
            } else {
                CKEDITOR.instances.NoiDungEdit.setData(data[2]);
            }
            
        });
        $('#' + table_id + ' tbody').on('click', '#xoact', function () {
            var data = tabledt.row($(this).parents('tr')).data();
            var r = confirm("Bạn có muốn xóa sự kiện:" + data[1] + " có ID là: " + data[0])
            if (r) {
                DeleteSuKien(data[0]);
            }
        });
        $('#' + table_id + ' tbody').on('click', '#tracuu', function () {
            var data = tabledt.row($(this).parents('tr')).data();

            TraCuu(data[0]);

        });
        $('#' + table_id + ' tbody').on('click', '#send_all', function () {
            var data = tabledt.row($(this).parents('tr')).data();

            var r = confirm("Bạn có muốn gửi thông báo sự kiện đến tất cả đoàn viên không?")
            if (r) {
                MailSuKien(data[0])
            }

        });
    };
    function UpdateSuKien() {
        var ID = $('#IDEdit').val();
       // var NoiDung = $('#NoiDungEdit').val();
        var NoiDung = CKEDITOR.instances.NoiDungEdit.getData().toString();
        var TenSuKien = $('#TenSuKienEdit').val();
        var DiaDiem = $('#DiaDiemEdit').val();
        var BatDau = $('#BatDauEdit').val();
        var GhiChu = $('#GhiChuEdit').val();
        if (NoiDung == "" || TenSuKien == "" || DiaDiem == "") {
            alert("Bạn cần nhập đầy đủ thông tin sự kiện");
        } else {
            open_loading_screen();
            $.ajax({
                type: "POST",
                url: "/SuKien/Update",
                dataType: "json",
                data: {
                    'ID': ID,
                    'NoiDung': NoiDung,
                    'Ten': TenSuKien,
                    'DiaDiem': DiaDiem,
                    'BatDau': BatDau,
                    'GhiChu': GhiChu
                },
                success: function (data) {
                    close_loading_screen();
                    alert(data.Message);
                    if (data.Status == 1) {
                        ListAll();
                        $('#UpdateSuKien').modal('hide');
                    }
                },
                error: function (err) {
                    close_loading_screen();
                    alert('Lỗi kết nối');

                }
            });
        }
    }
    function DeleteSuKien(ID) {
        open_loading_screen();
        $.ajax({
            type: "POST",
            url: "/SuKien/Delete",
            dataType: "json",
            data: {
                'ID': ID
            },
            success: function (data) {
                close_loading_screen();
                alert(data.Message);
                if (data.Status == 1) {
                    ListAll();
                }
            },
            error: function (err) {
                close_loading_screen();
                alert('Lỗi kết nối');

            }
        });
    }
    function MailSuKien(ID) {
        open_loading_screen();
        $.ajax({
            type: "POST",
            url: "/SuKien/SendMail",
            dataType: "json",
            data: {
                'ID': ID
            },
            success: function (data) {
                close_loading_screen();
                alert(data.Message);
                if (data.Status == 1) {
                    ListAll();
                }
            },
            error: function (err) {
                close_loading_screen();
                alert('Lỗi kết nối');

            }
        });
    }
    function AddSuKien() {
        //var NoiDung = $('#NoiDungAdd').val();
        var NoiDung = CKEDITOR.instances.NoiDungAdd.getData().toString();

        var TenSuKien = $('#TenSuKienAdd').val();
        var DiaDiem = $('#DiaDiemAdd').val();
        var BatDau = $('#BatDauAdd').val();
        var GhiChu = $('#GhiChuAdd').val();
        if (NoiDung == "" || TenSuKien == "" || DiaDiem == "") {
            alert("Bạn cần nhập đầy đủ thông tin sự kiện");
        } else {
            var dt = {
                'NoiDung': NoiDung,
                'Ten': TenSuKien,
                'DiaDiem': DiaDiem,
                'BatDau': BatDau,
                'GhiChu': GhiChu
            }
            console.log(dt)
            open_loading_screen();
            $.ajax({
                type: "POST",
                url: "/SuKien/Add",
                data: {
                    'm': dt
                },
                success: function (data) {
                    close_loading_screen();
                    alert(data.Message);
                    if (data.Status == 1) {
                        ListAll();
                        $('#AddSuKien').modal('hide');
                    }
                },
                error: function (err) {
                    close_loading_screen();
                    alert('Lỗi kết nối');

                }
            });
        }
    }
    function TraCuu(ID) {
        $.ajax({
            type: "POST",
            url: "/SuKien/TraCuu",
            dataType: "json",
            data: {
                'ID': ID
            },
            success: function (data) {
                console.log(data)
                fillTraCuu("TraCuuTable", data)
            },
            error: function (err) {
                alert('Lỗi kết nối');

            }
        });
    }
    function fillTraCuu(table_id, data) {
        var dataSet = new Array;
        $.each(data,
            function (index, value) {
                var tempArray = new Array;
                for (var o in value) {
                    tempArray.push(value[o]);
                }
                dataSet.push(tempArray);
            });
        var tabledt = $('#' + table_id + '').removeAttr('width').DataTable({
            select: true,
            "destroy": true,
            data: dataSet,

            "oLanguage": {

                "sProcessing": "Đang xử lý...",
                "sLengthMenu": "Xem _MENU_ mục",
                "sZeroRecords": "Không có dữ liệu",
                "sInfo": "Đang xem _START_ đến _END_ trong tổng số _TOTAL_ mục",
                "sInfoEmpty": "Đang xem 0 đến 0 trong tổng số 0 mục",
                "sInfoFiltered": "(được lọc từ _MAX_ mục)",
                "sInfoPostFix": "",
                "sSearch": "Tìm:",
                "sUrl": "",
                "oPaginate": {
                    "sFirst": "Đầu",
                    "sPrevious": "Trước",
                    "sNext": "Tiếp",
                    "sLast": "Cuối"

                }
            },
            columns: [
                { title: "ID" },
                { title: "Họ tên" },
                { title: "Ngày sinh" },
                { title: "Giới tính" },
                { title: "Ngày vào đoàn" },
                { title: "Địa chỉ" },
                { title: "Số điện thoại" },
                { title: "Email" }

            ],
        })
    };
    jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "de_datetime-asc": function ( a, b ) {
        var x, y;
        if (jQuery.trim(a) !== '') {
            var deDatea = jQuery.trim(a).split(' ');
            var deTimea = deDatea[1].split(':');
            var deDatea2 = deDatea[0].split('.');
                        if(typeof deTimea[2] != 'undefined') {
                            x = (deDatea2[2] + deDatea2[1] + deDatea2[0] + deTimea[0] + deTimea[1] + deTimea[2]) * 1;
                        } else {
                            x = (deDatea2[2] + deDatea2[1] + deDatea2[0] + deTimea[0] + deTimea[1]) * 1;
                        }
        } else {
            x = -Infinity; // = l'an 1000 ...
        }
 
        if (jQuery.trim(b) !== '') {
            var deDateb = jQuery.trim(b).split(' ');
            var deTimeb = deDateb[1].split(':');
            deDateb = deDateb[0].split('.');
                        if(typeof deTimeb[2] != 'undefined') {
                            y = (deDateb[2] + deDateb[1] + deDateb[0] + deTimeb[0] + deTimeb[1] + deTimeb[2]) * 1;
                        } else {
                            y = (deDateb[2] + deDateb[1] + deDateb[0] + deTimeb[0] + deTimeb[1]) * 1;
                        }
        } else {
            y = -Infinity;
        }
        var z = ((x < y) ? -1 : ((x > y) ? 1 : 0));
        return z;
    },
 
    "de_datetime-desc": function ( a, b ) {
        var x, y;
        if (jQuery.trim(a) !== '') {
            var deDatea = jQuery.trim(a).split(' ');
            var deTimea = deDatea[1].split(':');
            var deDatea2 = deDatea[0].split('.');
                        if(typeof deTimea[2] != 'undefined') {
                            x = (deDatea2[2] + deDatea2[1] + deDatea2[0] + deTimea[0] + deTimea[1] + deTimea[2]) * 1;
                        } else {
                            x = (deDatea2[2] + deDatea2[1] + deDatea2[0] + deTimea[0] + deTimea[1]) * 1;
                        }
        } else {
            x = Infinity;
        }
 
        if (jQuery.trim(b) !== '') {
            var deDateb = jQuery.trim(b).split(' ');
            var deTimeb = deDateb[1].split(':');
            deDateb = deDateb[0].split('.');
                        if(typeof deTimeb[2] != 'undefined') {
                            y = (deDateb[2] + deDateb[1] + deDateb[0] + deTimeb[0] + deTimeb[1] + deTimeb[2]) * 1;
                        } else {
                            y = (deDateb[2] + deDateb[1] + deDateb[0] + deTimeb[0] + deTimeb[1]) * 1;
                        }
        } else {
            y = -Infinity;
        }
        var z = ((x < y) ? 1 : ((x > y) ? -1 : 0));
        return z;
    },
 
    "de_date-asc": function ( a, b ) {
        var x, y;
        if (jQuery.trim(a) !== '') {
            var deDatea = jQuery.trim(a).split('.');
            x = (deDatea[2] + deDatea[1] + deDatea[0]) * 1;
        } else {
            x = Infinity; // = l'an 1000 ...
        }
 
        if (jQuery.trim(b) !== '') {
            var deDateb = jQuery.trim(b).split('.');
            y = (deDateb[2] + deDateb[1] + deDateb[0]) * 1;
        } else {
            y = -Infinity;
        }
        var z = ((x < y) ? -1 : ((x > y) ? 1 : 0));
        return z;
    },
 
    "de_date-desc": function ( a, b ) {
        var x, y;
        if (jQuery.trim(a) !== '') {
            var deDatea = jQuery.trim(a).split('.');
            x = (deDatea[2] + deDatea[1] + deDatea[0]) * 1;
        } else {
            x = -Infinity;
        }
 
        if (jQuery.trim(b) !== '') {
            var deDateb = jQuery.trim(b).split('.');
            y = (deDateb[2] + deDateb[1] + deDateb[0]) * 1;
        } else {
            y = Infinity;
        }
        var z = ((x < y) ? 1 : ((x > y) ? -1 : 0));
        return z;
    }
} );
</script>

